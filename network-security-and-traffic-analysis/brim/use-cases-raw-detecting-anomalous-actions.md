# Use Cases Raw (Detecting Anomalous Actions)

Brim Query Reference

| Purpose                                    | Syntax                                        | Example Query                                                                                                                                  |
| ------------------------------------------ | --------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------- |
| Basic search                               | You can search any string and numeric value.  | Find logs containing an IP address or any value.`10.0.0.1`                                                                                     |
| Logical operators                          | Or, And, Not.                                 | Find logs contain three digits of an IP AND NTP keyword.`192 and NTP`                                                                          |
| Filter values                              | "field name" == "value"                       | Filter source IP.`id.orig_h==192.168.121.40`                                                                                                   |
| <p>List specific log file contents<br></p> | <p>_path=="log name"<br></p>                  | List the contents of the conn log file.`_path=="conn"`                                                                                         |
| Count field values                         | count () by "field"                           | Count the number of the available log files.`count () by _path`                                                                                |
| Sort findings                              | sort                                          | Count the number of the available log files and sort recursively.`count () by _path \| sort -r`                                                |
| Cut specific field from a log file         | \_path=="conn" \| cut "field name"            | Cut the source IP, destination port and destination IP addresses from the conn log file.`_path=="conn" \| cut id.orig_h, id.resp_p, id.resp_h` |
| List unique values                         | uniq                                          | <p>Show the unique network connections. </p><p><code>_path=="conn" | cut id.orig_h, id.resp_p, id.resp_h | sort | uniq</code><br></p>          |

| <p>Communicated Hosts<br></p>                                       | <p>Identifying the list of <mark style="color:blue;">communicated hosts is the first step of the investigation</mark>. Security analysts need to know which hosts are actively communicating on the network to detect any suspicious and abnormal activity in the first place. This approach will help analysts to detect possible access violations, exploitation attempts and malware infections.</p><p><mark style="color:yellow;">Query: <code>_path=="conn" | cut</code></mark><code> </code><mark style="color:purple;"><code>id.orig_h, id.resp_h</code></mark><code> </code><mark style="color:yellow;"><code>| sort | uniq</code></mark><br></p>                                                                                                                                                                                                                                                                                                                                        |
| ------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| <p>Frequently Communicated Hosts<br></p>                            | <p>After having the list of communicated hosts, <mark style="color:blue;">it is important to identify which hosts communicate with each other most frequently</mark>. This will help security analysts to detect possible data exfiltration, exploitation and backdooring activities.</p><p><mark style="color:yellow;">Query: <code>_path=="conn" | cut</code></mark><code> </code><mark style="color:purple;"><code>id.orig_h, id.resp_h</code></mark><code> </code><mark style="color:yellow;"><code>| sort | uniq -c | sort -r</code></mark><br></p>                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| <p>Most Active Ports<br></p>                                        | <p>Suspicious activities are not always detectable in the first place. Attackers use multiple ways of hiding and bypassing methods to avoid detection. However, since the data is evidence, <mark style="color:blue;">it is impossible to hide the packet traces. Investigating the most active ports will help analysts to detect silent and well-hidden anomalies</mark> by focusing on the data bus and used services. </p><p><mark style="color:yellow;">Query: <code>_path=="conn" | cut id.resp_p,</code></mark><code> </code><mark style="color:purple;"><code>service</code></mark><code> </code><mark style="color:yellow;"><code>| sort | uniq -c | sort -r count</code></mark><br></p><p><mark style="color:yellow;">Query:  <code>_path=="conn" | cut id.orig_h, id.resp_h, id.resp_p,</code></mark><code> </code><mark style="color:purple;"><code>service</code></mark><code> </code><mark style="color:yellow;"><code>| sort id.resp_p | uniq -c | sort -r</code></mark> <br></p> |
| <p>Long Connections<br></p>                                         | <p>For security analysts, the long connections could be the first anomaly indicator. If the client is not designed to serve a continuous service, <mark style="color:blue;">investigating the connection duration between two IP addresses can reveal possible anomalies like backdoors.</mark></p><p><mark style="color:yellow;">Query: <code>_path=="conn" | cut id.orig_h, id.resp_p, id.resp_h,</code></mark><code> </code><mark style="color:purple;"><code>duration</code></mark><code> </code><mark style="color:yellow;"><code>| sort -r duration</code></mark><br></p>                                                                                                                                                                                                                                                                                                                                                                                                                  |
| <p>Transferred Data <br></p>                                        | <p>Another essential point is calculating the transferred data size. If the client is not designed to serve and receive files and act as a file server, <mark style="color:blue;">it is important to investigate the total bytes for each connection. Thus, analysts can distinguish possible data exfiltration or suspicious file actions</mark> like malware downloading and spreading.</p><p><mark style="color:yellow;">Query: <code>_path=="conn" | put total_bytes := orig_bytes + resp_bytes | sort -r total_bytes | cut uid, id, orig_bytes, resp_bytes, total_bytes</code></mark></p>                                                                                                                                                                                                                                                                                                                                                                                                   |
| <p>DNS and HTTP Queries<br></p>                                     | <p>Identifying suspicious and out of ordinary domain connections and requests is another significant point for a security analyst. <mark style="color:blue;">Abnormal connections can help detect C2 communications and possible compromised/infected hosts.</mark> <mark style="color:blue;">Identifying the suspicious DNS queries and HTTP requests help security analysts to detect malware C2 channels and support the investigation hypothesis.</mark><br></p><p><mark style="color:yellow;">Query: <code>_path=="dns" |</code></mark><code> </code><mark style="color:purple;"><code>count () by query</code></mark><code> </code><mark style="color:yellow;"><code>| sort -r</code></mark><br></p><p><mark style="color:yellow;">Query: <code>_path=="http" |</code></mark><code> </code><mark style="color:purple;"><code>count () by uri</code></mark><code> </code><mark style="color:yellow;"><code>| sort -r</code></mark></p>                                                      |
| <p>Suspicious Hostnames<br></p>                                     | <p>Identifying suspicious and out of ordinary hostnames helps analysts to detect rogue hosts. <mark style="color:blue;">Investigating the DHCP logs provides the hostname and domain information.</mark></p><p><mark style="color:yellow;">Query: <code>_path=="dhcp" | cut</code></mark><code> </code><mark style="color:purple;"><code>host_name, domain</code></mark><br></p>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| <p><mark style="color:blue;">Suspicious IP Addresses</mark><br></p> | <p>For security analysts, identifying suspicious and out of ordinary IP addresses is essential as identifying weird domain addresses. Since the connection logs are stored in one single log file (conn), filtering IP addresses is more manageable and provides more reliable results.</p><p>Query: <mark style="color:yellow;"><code>_path=="conn" | put</code></mark><code> </code><mark style="color:purple;"><code>classnet := network_of(id.resp_h) | cut classnet | count() by classnet | sort -r</code></mark><br></p>                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| <p><mark style="color:blue;">Detect Files</mark><br></p>            | <p>Investigating transferred files is another important point of traffic investigation. Performing this hunt will help security analysts to detect the transfer of malware or infected files by correlating the hash values. This act is also valuable for detecting transferring of sensitive files.</p><p><mark style="color:yellow;">Query: <code>filename!=null</code></mark><br></p>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| <p>SMB Activity<br></p>                                             | <p>Another significant point is investigating th<mark style="color:blue;">e SMB activity.</mark> This will help analysts to detect possible malicious activities <mark style="color:blue;">like exploitation, lateral movement and malicious file sharing.</mark> When running an investigation, it is suggested to ask, "What is going on in SMB?".</p><p><mark style="color:yellow;">Query: <code>_path=="dce_rpc" OR _path=="smb_mapping" OR _path=="smb_files"</code></mark></p>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| <p><mark style="color:blue;">Known Patterns</mark><br></p>          | <p>Known patterns represent alerts generated by security solutions. These alerts are generated against the common attack/threat/malware patterns and known by endpoint security products, firewalls and IDS/IPS solutions. This data source highly relies on available signatures, attacks and anomaly patterns. Investigating available log sources containing alerts is vital for a security analyst.</p><p>Brim supports the Zeek and Suricata logs, so any anomaly detected by these products will create a log file. Investigating these log files can provide a clue where the analyst should focus.</p><p>Query: <mark style="color:yellow;"><code>event_type=="alert" or _path=="notice" or _path=="signatures"</code></mark></p>                                                                                                                                                                                                                                                        |

\
